;(function($){var defaultSettings={allowZoom:true,allowPan:true,zoomCursor:"crosshair",panCursor:"move",disabledCursor:"not-allowed",viewportWidth:400,viewportHeight:300,maxWidth:2500,topX:-1,topY:-1,bottomX:-1,bottomY:-1,callback:function(topX,topY,bottomX,bottomY){}};function handleMouseOver(event){var image=$(this);var dim=image.data("dim");image.css("cursor",dim.cursor);}
function handleMouseOut(event){var image=$(this);var dim=image.data("dim");image.css("cursor",dim.cursor);}
function handleMouseDown(mousedownEvent){mousedownEvent.preventDefault();var image=$(this);var dim=image.data("dim");dim.origoX=mousedownEvent.clientX;dim.origoY=mousedownEvent.clientY;var clickX=(mousedownEvent.pageX-$(this).offset({scroll:false}).left);var clickY=(mousedownEvent.pageY-$(this).offset({scroll:false}).top);if(dim.allowZoom&&(mousedownEvent.shiftKey||mousedownEvent.ctrlKey)){dim.cursor=dim.zoomCursor;image.css("cursor",dim.zoomCursor);$("body").css("cursor",dim.zoomCursor);$(document).mousemove(function(e){image.zoom(e);});}
else if(dim.allowPan){dim.cursor=dim.panCursor;image.css("cursor",dim.panCursor);$("body").css("cursor",dim.panCursor);$(document).mousemove(function(e){image.pan(e);});}
$(document).mouseup(function(){var dim=image.data("dim");dim.cursor=dim.panCursor;$("body").css("cursor","default");image.css("cursor",dim.cursor);$(this).unbind("mousemove").unbind("mouseup").unbind("mouseout");image.store();});return false;}
$.fn.extend({setup:function(){var image=$(this);var dim=image.data("dim");dim.cursor=dim.panCursor;dim.width=dim.imageWidth;dim.height=dim.imageHeight;if(dim.topX<0){dim.topX=0;dim.topY=0;if((dim.imageWidth/dim.viewportWidth)>(dim.imageHeight/dim.viewportHeight)){dim.bottomY=dim.imageHeight;dim.bottomX=dim.viewportWidth*(dim.imageHeight/dim.viewportHeight);}
else{dim.bottomX=dim.imageWidth;dim.bottomY=dim.viewportHeight*(dim.imageWidth/dim.viewportWidth);}}
var scaleX=dim.viewportWidth/(dim.bottomX-dim.topX);var scaleY=dim.viewportHeight/(dim.bottomY-dim.topY);dim.width=dim.width*scaleX;dim.height=dim.height*scaleY;dim.oldWidth=dim.width;dim.oldHeight=dim.height;dim.x=-(dim.topX*scaleX);dim.y=-(dim.topY*scaleY);image.resize();image.store();image.css({position:"relative",display:"block"});if(dim.allowPan||dim.allowZoom){image.mousedown(handleMouseDown);image.mouseover(handleMouseOver);image.mouseout(handleMouseOut);}
else{image.css("cursor",dim.disabledCursor);image.mousedown(function(e){e.preventDefault();});}},imagetool:function(settings){return this.each(function(){var image=$(this).css({display:"none"});var dim=$.extend({},defaultSettings,settings);image.data("dim",dim);var viewportCss={backgroundColor:"#fff",position:"relative",overflow:"hidden",width:dim.viewportWidth+"px",height:dim.viewportHeight+"px"};var viewportElement=$("<div class=\"viewport\"><\/div>");viewportElement.css(viewportCss);image.wrap(viewportElement);$(this).setup();});},store:function(){var image=$(this);var dim=image.data("dim");var scale=dim.width/dim.imageWidth;dim.topX=(-dim.x)/scale;dim.topY=(-dim.y)/scale;dim.bottomX=dim.topX+(dim.viewportWidth/scale);dim.bottomY=dim.topY+(dim.viewportHeight/scale);if(typeof dim.callback=='function'){dim.callback(parseInt(dim.topX),parseInt(dim.topY),parseInt(dim.bottomX),parseInt(dim.bottomY));}
return image;},zoom:function(e){e.preventDefault();var image=$(this);var dim=image.data("dim");var factor=(dim.origoY-e.clientY);dim.oldWidth=dim.width;dim.oldHeight=dim.height;dim.width=((factor/100)*dim.width)+dim.width;dim.height=((factor/100)*dim.height)+dim.height;if(image.resize()){dim.origoY=e.clientY;}},pan:function(e){e.preventDefault();var image=$(this);var dim=image.data("dim");var deltaX=dim.origoX-e.clientX;var deltaY=dim.origoY-e.clientY;dim.origoX=e.clientX;dim.origoY=e.clientY;var targetX=dim.x-deltaX;var targetY=dim.y-deltaY;var minX=-dim.width+dim.viewportWidth;var minY=-dim.height+dim.viewportHeight;dim.x=targetX;dim.y=targetY;image.move();},move:function(){var image=$(this);var dim=image.data("dim");var minX=-dim.width+dim.viewportWidth;var minY=-dim.height+dim.viewportHeight;if(dim.x>0){dim.x=0;}
else if(dim.x<minX){dim.x=minX;}
if(dim.y>0){dim.y=0;}
else if(dim.y<minY){dim.y=minY;}
$(this).css({left:dim.x+"px",top:dim.y+"px"});return image;},resize:function(){var image=$(this);var dim=image.data("dim");var wasResized=true;if(dim.width<dim.viewportWidth){dim.height=parseInt(dim.imageHeight*(dim.viewportWidth/dim.imageWidth));dim.width=dim.viewportWidth;wasResized=false;}
if(dim.height<dim.viewportHeight){dim.width=parseInt(dim.imageWidth*(dim.viewportHeight/dim.imageHeight));dim.height=dim.viewportHeight;wasResized=false;}
if(dim.width>dim.maxWidth){dim.height=parseInt(dim.height*(dim.maxWidth/dim.width));dim.width=dim.maxWidth;wasResized=false;}
$(this).css({width:dim.width+"px",height:dim.height+"px"});var cx=dim.width/(-dim.x+(dim.viewportWidth/2));var cy=dim.height/(-dim.y+(dim.viewportHeight/2));dim.x=dim.x-((dim.width-dim.oldWidth)/cx);dim.y=dim.y-((dim.height-dim.oldHeight)/cy);$(this).move();return wasResized;}});})(jQuery);